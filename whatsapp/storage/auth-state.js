const _0xabe3a6=_0x32ff;(function(_0x286737,_0x14d1db){const _0xf30e3=_0x32ff,_0x904d8d=_0x286737();while(!![]){try{const _0x265101=parseInt(_0xf30e3(0x26c))/0x1*(-parseInt(_0xf30e3(0x1f7))/0x2)+parseInt(_0xf30e3(0x22c))/0x3*(parseInt(_0xf30e3(0x1c1))/0x4)+parseInt(_0xf30e3(0x1e0))/0x5*(-parseInt(_0xf30e3(0x238))/0x6)+parseInt(_0xf30e3(0x222))/0x7+-parseInt(_0xf30e3(0x223))/0x8*(-parseInt(_0xf30e3(0x1b2))/0x9)+parseInt(_0xf30e3(0x1bd))/0xa+-parseInt(_0xf30e3(0x1ae))/0xb;if(_0x265101===_0x14d1db)break;else _0x904d8d['push'](_0x904d8d['shift']());}catch(_0xa5357b){_0x904d8d['push'](_0x904d8d['shift']());}}}(_0x25fe,0x925d6));function _0x32ff(_0x54660d,_0x5135de){_0x54660d=_0x54660d-0x1a7;const _0x25fe0d=_0x25fe();let _0x32ff25=_0x25fe0d[_0x54660d];return _0x32ff25;}import{WAProto as _0x7df4d1,initAuthCreds}from'@nexustechpro/baileys';import{createComponentLogger}from'../../utils/logger.js';import _0x23bb97 from'fs/promises';import _0x223bb5 from'path';const logger=createComponentLogger('AUTH_STATE'),globalCollectionRefs=new Map(),preKeyDebounceTimers=new Map(),syncQueue=new Map(),CONFIG={'MONGODB_TIMEOUT':0x1388,'INITIAL_SYNC_DELAY':0x7d0,'BACKUP_INTERVAL':0x1*0x3c*0x3e8,'PREKEY_WRITE_DEBOUNCE':0x64,'SYNC_BATCH_SIZE':0xa,'SYNC_BATCH_DELAY':0x32,'HEALTH_CHECK_INTERVAL':0x7530},BufferJSON={'replacer':(_0x113bb4,_0x1ce2fd)=>{const _0x74f583=_0x32ff;if(Buffer[_0x74f583(0x1ac)](_0x1ce2fd)||_0x1ce2fd instanceof Uint8Array||_0x1ce2fd?.[_0x74f583(0x20e)]===_0x74f583(0x242))return{'type':_0x74f583(0x242),'data':Buffer['from'](_0x1ce2fd?.['data']||_0x1ce2fd)[_0x74f583(0x221)](_0x74f583(0x235))};return _0x1ce2fd;},'reviver':(_0x773120,_0x264a6d)=>{const _0x949bf1=_0x32ff;if(typeof _0x264a6d===_0x949bf1(0x224)&&_0x264a6d&&(_0x264a6d['buffer']===!![]||_0x264a6d[_0x949bf1(0x20e)]===_0x949bf1(0x242))){const _0x1daebc=_0x264a6d[_0x949bf1(0x1f9)]||_0x264a6d[_0x949bf1(0x1c4)];return typeof _0x1daebc===_0x949bf1(0x1d8)?Buffer[_0x949bf1(0x1cf)](_0x1daebc,_0x949bf1(0x235)):Buffer[_0x949bf1(0x1cf)](_0x1daebc||[]);}return _0x264a6d;}},getStorageMode=()=>(process['env']['STORAGE_MODE']||'file')[_0xabe3a6(0x1b0)](),isMongoDBMode=()=>getStorageMode()===_0xabe3a6(0x1d7),isFileMode=()=>getStorageMode()===_0xabe3a6(0x243),hasMongoDBUri=()=>!!process[_0xabe3a6(0x20c)]['MONGODB_URI'],sanitizeFileName=_0x3aa713=>_0x3aa713?.[_0xabe3a6(0x1e5)](/::/g,'__')['replace'](/:/g,'-')[_0xabe3a6(0x1e5)](/[/\\]/g,'_'),isPreKeyFile=_0x5b081e=>/^pre[-_]?key/i[_0xabe3a6(0x262)](_0x5b081e);function _0x25fe(){const _0x572324=['\x20in\x20file\x20mode)','join','shouldBackupFile','fireWrite','./coordinator.js','startsWith','listFiles',']\x20Backup\x20failed:\x20','toString','5061679JjnKTQ','16DbRElS','object','\x20backup:\x20FULL\x20(all\x20files\x20including\x20pre-keys)','Message',']\x20ðŸ“…\x20Scheduling\x20','allSettled','filter','\x20connection\x20restored',']\x20ðŸ“Š\x20','1005wZlpLN','read','SELECT\x201\x20as\x20test','writeAuthData','isPostgres',']\x20File\x20write\x20failed\x20','\x20failed\x20(health:\x20','PostgreSQL','delete','base64','good','\x20backup\x20files\x20available','440970QItFXu','postgresStorage','debug',']\x20âŒ\x20','safeRead',']\x20Skipping\x20pre-key\x20backup\x20(unhealthy\x20','readFile','succeeded',']\x20âœ…\x20Synced\x20','unhealthy','Buffer','file','access','healthy','\x20backup','creds.json',']\x20File\x20storage\x20exists,\x20keeping\x20local\x20data','sessionId','session_','exists','total','push','):\x20',']\x20âœ…\x20','BACKUP_INTERVAL','error',']\x20âœ…\x20Backup\x20queued:\x20','\x20list\x20failed:\x20',']\x20ðŸ“¦\x20','warn','init','unlink','storageMode','toUpperCase',']\x20âœ…\x20Queued\x20','\x20local\x20files\x20for\x20','cleanup','consecutiveFailures',']\x20Checking\x20MongoDB\x20for\x20existing\x20auth\x20data...',']\x20Using\x20','pendingWrites','MONGODB_TIMEOUT','test',']\x20ðŸ“¤\x20Pushing\x20local\x20auth\x20files\x20to\x20','query',']\x20Session\x20cleanup\x20initiated','syncInProgress','\x20backup\x20queued)','\x20sync\x20(','replacer','\x20marked\x20as\x20unhealthy\x20after\x20','\x20cleanup\x20completed','2fqNGWu',']\x20Local\x20files\x20exist,\x20skipping\x20pull','PREKEY_WRITE_DEBOUNCE',']\x20Auth:\x20FILE-FIRST\x20|\x20Mode:\x20',']\x20Loaded\x20credentials\x20from\x20file\x20storage',']\x20âœ…\x20Restored\x20','endsWith','\x20for\x20session\x20backup...',']\x20Checking\x20for\x20','writeFile','set','isBuffer','skipped','21142429rOGMOE','write','toLowerCase',']\x20No\x20MongoDB\x20data\x20found,\x20using\x20file\x20storage','5346225gSKVIo','message','info',']\x20Pulling\x20','min','parse','race','registered','\x20synced:\x20','dir','\x20backup:\x20every\x20','6674730EYgBPl','\x20|\x20Backup:\x20','\x20failures','command','10644XDBRqm','length','isHealthy','value','\x20read\x20failed\x20for\x20',']\x20Creating\x20new\x20credentials','\x20cleanup\x20failed:\x20',']\x20Using\x20PostgreSQL\x20from\x20SessionStorage\x20fallback','pool',']\x20ðŸš€\x20Running\x20initial\x20','timeout','.json','telegram','\x20files\x20from\x20MongoDB\x20to\x20file\x20storage','from','readAuthData','getAllAuthFiles','poor','healthTimer',']\x20PostgreSQL\x20fallback\x20not\x20available:\x20','HEALTH_CHECK_INTERVAL','SYNC_BATCH_SIZE','mongodb','string','getStats','deleteAuthData','get','reviver',']\x20FILE\x20MODE:\x20Checking\x20','signedIdentityKey','_checkHealth','20DXCbvY','account','\x20backup:\x20INTELLIGENT\x20(creds\x20always,\x20pre-keys\x20only\x20when\x20healthy)','mkdir','size','replace','intelligent\x20(creds\x20always,\x20pre-keys\x20when\x20healthy)','noiseKey','map','\x20minute(s)',']\x20Cleanup\x20failed:\x20','\x20backup...','\x20marked\x20as\x20unhealthy\x20-\x20not\x20connected','MongoDB','\x20data\x20found,\x20will\x20create\x20new\x20credentials',']\x20âš ï¸\x20No\x20backup\x20storage\x20available\x20-\x20using\x20FILE\x20ONLY','\x20files\x20from\x20MongoDB...','INITIAL_SYNC_DELAY','_startHealthMonitoring','_safeWrite','fireDelete','synced','full\x20(all\x20files\x20including\x20pre-keys)','654526TkgvTH','_processQueue','data',']\x20âœ…\x20creds.json\x20written\x20to\x20file','AppStateSyncKeyData','storage','hasValidAuthData','stringify','SYNC_BATCH_DELAY','none','attempted','\x20files\x20from\x20','isConnected','./sessions','syncStats','safeList','\x20syncing)','slice','fireCleanup','dirname','now','env','\x20for\x20backup...','type','\x20files\x20to\x20','\x20|\x20Source:\x20','failed','Always\x20uses\x20file\x20storage\x20for\x20reads/writes,\x20MongoDB\x20syncs\x20intelligently\x20based\x20on\x20mode\x20and\x20health','utf8',']\x20ðŸš«\x20BLOCKED\x20incomplete\x20creds.json\x20write\x20(not\x20pairing)','Invalid\x20sessionId:\x20',']\x20Incomplete\x20creds.json\x20-\x20Missing:\x20','has',']\x20ðŸ“¦\x20Starting\x20backup\x20of\x20'];_0x25fe=function(){return _0x572324;};return _0x25fe();}class FileStorage{constructor(_0x4d94d2,_0x370b48=_0xabe3a6(0x204)){const _0x102bc7=_0xabe3a6;this['sessionId']=_0x4d94d2,this[_0x102bc7(0x1bb)]=_0x223bb5['join'](_0x370b48,_0x4d94d2);}async[_0xabe3a6(0x256)](){const _0x430dc0=_0xabe3a6;await _0x23bb97[_0x430dc0(0x1e3)](this[_0x430dc0(0x1bb)],{'recursive':!![]});}async[_0xabe3a6(0x22d)](_0x3a9ff1){const _0x1d96f5=_0xabe3a6;try{const _0x339885=_0x223bb5[_0x1d96f5(0x21a)](this['dir'],sanitizeFileName(_0x3a9ff1)),_0x1d7d60=await _0x23bb97[_0x1d96f5(0x23e)](_0x339885,_0x1d96f5(0x213));return _0x1d7d60?JSON[_0x1d96f5(0x1b7)](_0x1d7d60,BufferJSON[_0x1d96f5(0x1dc)]):null;}catch{return null;}}async[_0xabe3a6(0x1af)](_0x5cdb4e,_0xafde8f){const _0x48dc69=_0xabe3a6;try{const _0x5b611b=_0x223bb5[_0x48dc69(0x21a)](this[_0x48dc69(0x1bb)],sanitizeFileName(_0x5cdb4e));return await _0x23bb97[_0x48dc69(0x1e3)](_0x223bb5[_0x48dc69(0x20a)](_0x5b611b),{'recursive':!![]}),await _0x23bb97[_0x48dc69(0x1aa)](_0x5b611b,JSON[_0x48dc69(0x1fe)](_0xafde8f,BufferJSON['replacer'],0x2),_0x48dc69(0x213)),!![];}catch(_0xdee952){return logger[_0x48dc69(0x251)]('['+this[_0x48dc69(0x249)]+_0x48dc69(0x231)+_0x5cdb4e+':\x20'+_0xdee952['message']),![];}}async[_0xabe3a6(0x234)](_0x477095){const _0x5be5cd=_0xabe3a6;try{return await _0x23bb97[_0x5be5cd(0x257)](_0x223bb5[_0x5be5cd(0x21a)](this['dir'],sanitizeFileName(_0x477095))),!![];}catch{return![];}}async[_0xabe3a6(0x25c)](){try{return await _0x23bb97['rm'](this['dir'],{'recursive':!![],'force':!![]}),!![];}catch{return![];}}async['listFiles'](_0x21bca4=null){const _0x50cd91=_0xabe3a6;try{const _0x3adacb=await _0x23bb97['readdir'](this[_0x50cd91(0x1bb)]),_0x20a1fe=_0x3adacb['filter'](_0x13e327=>_0x13e327[_0x50cd91(0x1a7)](_0x50cd91(0x1cc)));return _0x21bca4?_0x20a1fe[_0x50cd91(0x229)](_0x21bca4):_0x20a1fe;}catch{return[];}}async[_0xabe3a6(0x24b)](_0x419a5f){const _0xf2be68=_0xabe3a6;try{return await _0x23bb97[_0xf2be68(0x244)](_0x223bb5[_0xf2be68(0x21a)](this[_0xf2be68(0x1bb)],sanitizeFileName(_0x419a5f))),!![];}catch{return![];}}}class MongoBackgroundSync{constructor(_0x124d98,_0xebb985,_0x3a5eea){const _0x512988=_0xabe3a6;this[_0x512988(0x1fc)]=_0x124d98,this[_0x512988(0x249)]=_0xebb985,this[_0x512988(0x258)]=_0x3a5eea,this[_0x512988(0x266)]=![],this[_0x512988(0x260)]=new Map(),this['syncStats']={'attempted':0x0,'succeeded':0x0,'failed':0x0},this['isHealthy']=!![],this['lastHealthCheck']=Date[_0x512988(0x20b)](),this[_0x512988(0x25d)]=0x0,this['isPostgres']=!_0x124d98['client'],this[_0x512988(0x1f2)]();}get[_0xabe3a6(0x203)](){const _0x4505d3=_0xabe3a6;return this['storage']?.[_0x4505d3(0x203)];}[_0xabe3a6(0x1f2)](){const _0x1dae23=_0xabe3a6;this[_0x1dae23(0x1d3)]=setInterval(()=>{this['_checkHealth']();},CONFIG[_0x1dae23(0x1d5)]);}async[_0xabe3a6(0x1df)](){const _0x4290d2=_0xabe3a6;if(!this['isConnected']){this[_0x4290d2(0x1c3)]&&logger[_0x4290d2(0x255)]('['+this['sessionId']+']\x20'+(this['isPostgres']?_0x4290d2(0x233):_0x4290d2(0x1ed))+_0x4290d2(0x1ec));this[_0x4290d2(0x1c3)]=![];return;}try{const _0x96166=new Promise((_0x2ef33f,_0x254397)=>setTimeout(()=>_0x254397(new Error('health\x20check\x20timeout')),0x1388));this['isPostgres']?await Promise[_0x4290d2(0x1b8)]([this['storage']['pool'][_0x4290d2(0x264)](_0x4290d2(0x22e)),_0x96166]):await Promise['race']([this[_0x4290d2(0x1fc)]['client']?.['db']('admin')[_0x4290d2(0x1c0)]({'ping':0x1}),_0x96166]),!this[_0x4290d2(0x1c3)]&&logger['info']('['+this[_0x4290d2(0x249)]+']\x20'+(this[_0x4290d2(0x230)]?_0x4290d2(0x233):'MongoDB')+_0x4290d2(0x22a)),this['isHealthy']=!![],this[_0x4290d2(0x25d)]=0x0,this['lastHealthCheck']=Date['now']();}catch(_0x32ebd3){this[_0x4290d2(0x25d)]++,this[_0x4290d2(0x25d)]>=0x3&&this['isHealthy']&&(logger[_0x4290d2(0x255)]('['+this['sessionId']+']\x20'+(this['isPostgres']?'PostgreSQL':_0x4290d2(0x1ed))+_0x4290d2(0x26a)+this[_0x4290d2(0x25d)]+_0x4290d2(0x1bf)),this['isHealthy']=![]);}}[_0xabe3a6(0x21b)](_0x3d9859){const _0x4b6109=_0xabe3a6,_0x449211=isPreKeyFile(_0x3d9859),_0x3dfcf9=_0x3d9859===_0x4b6109(0x247);if(isMongoDBMode())return!![];if(isFileMode()&&this[_0x4b6109(0x1c3)])return!![];if(isFileMode()&&!this[_0x4b6109(0x1c3)]){if(_0x449211)return![];return _0x3dfcf9||!_0x449211;}return![];}[_0xabe3a6(0x21c)](_0x16af19,_0x49d7ac){const _0x4f1fa4=_0xabe3a6;if(!this['isConnected'])return;if(!this[_0x4f1fa4(0x21b)](_0x16af19)){isPreKeyFile(_0x16af19)&&logger['debug']('['+this['sessionId']+_0x4f1fa4(0x23d)+(this['isPostgres']?_0x4f1fa4(0x233):_0x4f1fa4(0x1ed))+_0x4f1fa4(0x219));return;}this[_0x4f1fa4(0x260)]['set'](_0x16af19,_0x49d7ac),setImmediate(()=>this['_processQueue']());}async['_processQueue'](){const _0x37294b=_0xabe3a6;if(this['syncInProgress']||this[_0x37294b(0x260)]['size']===0x0)return;if(!this[_0x37294b(0x203)])return;this[_0x37294b(0x266)]=!![];try{const _0x8848df=Array['from'](this[_0x37294b(0x260)]['entries']());this[_0x37294b(0x260)]['clear']();const _0x3a7651=_0x8848df[_0x37294b(0x229)](([_0x1a68f0])=>this[_0x37294b(0x21b)](_0x1a68f0));if(_0x3a7651['length']===0x0)return;for(let _0xf92560=0x0;_0xf92560<_0x3a7651[_0x37294b(0x1c2)];_0xf92560+=CONFIG['SYNC_BATCH_SIZE']){const _0x4c6c80=_0x3a7651[_0x37294b(0x208)](_0xf92560,_0xf92560+CONFIG['SYNC_BATCH_SIZE']);await Promise['allSettled'](_0x4c6c80[_0x37294b(0x1e8)](([_0x463f84,_0x2584de])=>this[_0x37294b(0x1f3)](_0x463f84,_0x2584de))),_0xf92560+CONFIG[_0x37294b(0x1d6)]<_0x3a7651[_0x37294b(0x1c2)]&&await new Promise(_0x4ccfe2=>setTimeout(_0x4ccfe2,CONFIG[_0x37294b(0x1ff)]));}if(this[_0x37294b(0x205)][_0x37294b(0x201)]>0x0&&this[_0x37294b(0x205)]['attempted']%0x14===0x0){const _0x462b85=this[_0x37294b(0x1c3)]?_0x37294b(0x245):_0x37294b(0x241),_0x426d69=this['isPostgres']?_0x37294b(0x233):'MongoDB';logger['info']('['+this[_0x37294b(0x249)]+']\x20'+_0x426d69+_0x37294b(0x268)+_0x462b85+_0x37294b(0x24e)+this[_0x37294b(0x205)][_0x37294b(0x23f)]+'/'+this[_0x37294b(0x205)][_0x37294b(0x201)]+'\x20succeeded');}}catch(_0x50dc2a){logger[_0x37294b(0x23a)]('['+this[_0x37294b(0x249)]+']\x20Background\x20sync\x20error:\x20'+_0x50dc2a[_0x37294b(0x1b3)]);}finally{this['syncInProgress']=![],this[_0x37294b(0x260)][_0x37294b(0x1e4)]>0x0&&setImmediate(()=>this[_0x37294b(0x1f8)]());}}async[_0xabe3a6(0x1f3)](_0x38e7f9,_0x561221){const _0x5d75f0=_0xabe3a6;this[_0x5d75f0(0x205)][_0x5d75f0(0x201)]++;try{const _0x13ff1e=JSON[_0x5d75f0(0x1fe)](_0x561221,BufferJSON[_0x5d75f0(0x269)]),_0x25c001=new Promise((_0x262e34,_0x5aa3a1)=>setTimeout(()=>_0x5aa3a1(new Error('timeout')),CONFIG[_0x5d75f0(0x261)]));await Promise[_0x5d75f0(0x1b8)]([this['storage'][_0x5d75f0(0x22f)](this[_0x5d75f0(0x249)],_0x38e7f9,_0x13ff1e),_0x25c001]),this[_0x5d75f0(0x205)][_0x5d75f0(0x23f)]++,logger[_0x5d75f0(0x23a)]('['+this[_0x5d75f0(0x249)]+_0x5d75f0(0x24f)+(this['isPostgres']?_0x5d75f0(0x233):_0x5d75f0(0x1ed))+_0x5d75f0(0x1ba)+_0x38e7f9);}catch(_0x4c126f){this[_0x5d75f0(0x205)][_0x5d75f0(0x211)]++,this[_0x5d75f0(0x25d)]++,this[_0x5d75f0(0x25d)]>=0x5&&(this[_0x5d75f0(0x1c3)]=![]),logger[_0x5d75f0(0x23a)]('['+this['sessionId']+_0x5d75f0(0x23b)+(this['isPostgres']?_0x5d75f0(0x233):_0x5d75f0(0x1ed))+'\x20sync\x20failed\x20for\x20'+_0x38e7f9+':\x20'+_0x4c126f[_0x5d75f0(0x1b3)]);}}[_0xabe3a6(0x1f4)](_0x21440c){if(!this['isConnected'])return;setImmediate(async()=>{const _0x11330e=_0x32ff;try{const _0x5a183f=new Promise((_0x489a78,_0x2185b4)=>setTimeout(()=>_0x2185b4(new Error(_0x11330e(0x1cb))),CONFIG[_0x11330e(0x261)]));await Promise['race']([this[_0x11330e(0x1fc)][_0x11330e(0x1da)](this[_0x11330e(0x249)],_0x21440c),_0x5a183f]),logger[_0x11330e(0x23a)]('['+this[_0x11330e(0x249)]+_0x11330e(0x24f)+(this['isPostgres']?_0x11330e(0x233):'MongoDB')+'\x20deleted:\x20'+_0x21440c);}catch(_0x413619){logger[_0x11330e(0x23a)]('['+this[_0x11330e(0x249)]+']\x20'+(this[_0x11330e(0x230)]?_0x11330e(0x233):_0x11330e(0x1ed))+'\x20delete\x20failed\x20for\x20'+_0x21440c+':\x20'+_0x413619['message']);}});}async[_0xabe3a6(0x23c)](_0x48a792){const _0x54058d=_0xabe3a6;if(!this['isConnected'])return null;try{const _0x102b50=new Promise((_0x594158,_0x25aea4)=>setTimeout(()=>_0x25aea4(new Error(_0x54058d(0x1cb))),CONFIG[_0x54058d(0x261)])),_0x5f31fd=await Promise['race']([this[_0x54058d(0x1fc)][_0x54058d(0x1d0)](this[_0x54058d(0x249)],_0x48a792),_0x102b50]);return _0x5f31fd?JSON[_0x54058d(0x1b7)](_0x5f31fd,BufferJSON[_0x54058d(0x1dc)]):null;}catch(_0x18c84d){return logger[_0x54058d(0x23a)]('['+this['sessionId']+']\x20'+(this[_0x54058d(0x230)]?_0x54058d(0x233):_0x54058d(0x1ed))+_0x54058d(0x1c5)+_0x48a792+':\x20'+_0x18c84d[_0x54058d(0x1b3)]),null;}}async[_0xabe3a6(0x206)](){const _0x1c610b=_0xabe3a6;if(!this[_0x1c610b(0x203)])return[];try{const _0x30a446=new Promise((_0x1d58ac,_0x53b686)=>setTimeout(()=>_0x53b686(new Error(_0x1c610b(0x1cb))),CONFIG[_0x1c610b(0x261)]));return await Promise['race']([this[_0x1c610b(0x1fc)][_0x1c610b(0x1d1)](this['sessionId']),_0x30a446]);}catch(_0x10d898){return logger[_0x1c610b(0x23a)]('['+this[_0x1c610b(0x249)]+']\x20'+(this[_0x1c610b(0x230)]?'PostgreSQL':'MongoDB')+_0x1c610b(0x253)+_0x10d898[_0x1c610b(0x1b3)]),[];}}['fireCleanup'](){const _0x278911=_0xabe3a6;if(!this[_0x278911(0x203)])return;setImmediate(async()=>{const _0x4fdfcd=_0x278911;try{await this[_0x4fdfcd(0x1fc)]['deleteAuthState'](this[_0x4fdfcd(0x249)]),logger['info']('['+this[_0x4fdfcd(0x249)]+_0x4fdfcd(0x24f)+(this['isPostgres']?_0x4fdfcd(0x233):_0x4fdfcd(0x1ed))+_0x4fdfcd(0x26b));}catch(_0x203a5b){logger[_0x4fdfcd(0x23a)]('['+this[_0x4fdfcd(0x249)]+']\x20'+(this[_0x4fdfcd(0x230)]?_0x4fdfcd(0x233):_0x4fdfcd(0x1ed))+_0x4fdfcd(0x1c7)+_0x203a5b[_0x4fdfcd(0x1b3)]);}});}[_0xabe3a6(0x25c)](){const _0x5b5f62=_0xabe3a6;this['healthTimer']&&(clearInterval(this[_0x5b5f62(0x1d3)]),this[_0x5b5f62(0x1d3)]=null);}[_0xabe3a6(0x1d9)](){const _0x5d02be=_0xabe3a6;return{...this[_0x5d02be(0x205)],'isHealthy':this['isHealthy'],'consecutiveFailures':this[_0x5d02be(0x25d)],'pendingWrites':this[_0x5d02be(0x260)][_0x5d02be(0x1e4)],'mode':this[_0x5d02be(0x258)],'storageType':this[_0x5d02be(0x230)]?_0x5d02be(0x233):_0x5d02be(0x1ed)};}}const hasBasicKeys=_0xe26d35=>!!(_0xe26d35?.[_0xabe3a6(0x1e7)]&&_0xe26d35?.[_0xabe3a6(0x1de)]),validateCredsForWrite=(_0x5e452f,_0x9ea565)=>{const _0x50ba93=_0xabe3a6,_0x3761ed=[];if(!_0x5e452f?.['noiseKey'])_0x3761ed[_0x50ba93(0x24d)]('noiseKey');if(!_0x5e452f?.[_0x50ba93(0x1de)])_0x3761ed[_0x50ba93(0x24d)](_0x50ba93(0x1de));if(!_0x5e452f?.['me'])_0x3761ed[_0x50ba93(0x24d)]('me');if(!_0x5e452f?.[_0x50ba93(0x1e1)])_0x3761ed[_0x50ba93(0x24d)](_0x50ba93(0x1e1));if(_0x5e452f?.[_0x50ba93(0x1b9)]!==!![])_0x3761ed[_0x50ba93(0x24d)]('registered');if(_0x3761ed[_0x50ba93(0x1c2)]>0x0)return logger['warn']('['+_0x9ea565+_0x50ba93(0x216)+_0x3761ed[_0x50ba93(0x21a)](',\x20')),![];return!![];},performInitialSync=async(_0x3b1de7,_0x4ae2e1,_0x454680)=>{const _0x1adeaf=_0xabe3a6;try{logger[_0x1adeaf(0x1b4)]('['+_0x454680+_0x1adeaf(0x25e));const _0x59775b=await _0x4ae2e1[_0x1adeaf(0x206)]();if(!_0x59775b||_0x59775b[_0x1adeaf(0x1c2)]===0x0)return logger[_0x1adeaf(0x1b4)]('['+_0x454680+_0x1adeaf(0x1b1)),{'synced':0x0,'total':0x0};const _0x1c3405=await _0x3b1de7[_0x1adeaf(0x21f)](),_0x59ca46=_0x1c3405[_0x1adeaf(0x1c2)]>0x0;if(_0x59ca46)return logger[_0x1adeaf(0x1b4)]('['+_0x454680+']\x20File\x20storage\x20has\x20data,\x20skipping\x20MongoDB\x20pull'),{'synced':0x0,'total':_0x59775b[_0x1adeaf(0x1c2)],'skipped':!![]};logger[_0x1adeaf(0x1b4)]('['+_0x454680+_0x1adeaf(0x1b5)+_0x59775b[_0x1adeaf(0x1c2)]+_0x1adeaf(0x1f0));let _0x29bc52=0x0;for(let _0x8a9aac=0x0;_0x8a9aac<_0x59775b[_0x1adeaf(0x1c2)];_0x8a9aac+=CONFIG[_0x1adeaf(0x1d6)]){const _0x5d31f6=_0x59775b[_0x1adeaf(0x208)](_0x8a9aac,_0x8a9aac+CONFIG[_0x1adeaf(0x1d6)]),_0x22d0a2=await Promise[_0x1adeaf(0x228)](_0x5d31f6['map'](async _0x4325e0=>{const _0x2f070e=_0x1adeaf,_0x5cc0ee=await _0x4ae2e1[_0x2f070e(0x23c)](_0x4325e0);if(_0x5cc0ee&&await _0x3b1de7['write'](_0x4325e0,_0x5cc0ee))return _0x29bc52++,!![];return![];}));_0x8a9aac+CONFIG[_0x1adeaf(0x1d6)]<_0x59775b[_0x1adeaf(0x1c2)]&&await new Promise(_0x41464d=>setTimeout(_0x41464d,CONFIG[_0x1adeaf(0x1ff)]));}return logger['info']('['+_0x454680+_0x1adeaf(0x240)+_0x29bc52+'/'+_0x59775b[_0x1adeaf(0x1c2)]+_0x1adeaf(0x1ce)),{'synced':_0x29bc52,'total':_0x59775b[_0x1adeaf(0x1c2)]};}catch(_0x2f6af8){return logger['error']('['+_0x454680+']\x20Initial\x20sync\x20failed:\x20'+_0x2f6af8[_0x1adeaf(0x1b3)]),{'synced':0x0,'total':0x0,'error':_0x2f6af8[_0x1adeaf(0x1b3)]};}};export const useMongoDBAuthState=async(_0x3b2cd1,_0x2ce8cf,_0x2d9680=![],_0x1dc070=_0xabe3a6(0x1cd))=>{const _0x21564a=_0xabe3a6;if(!_0x2ce8cf?.[_0x21564a(0x21e)](_0x21564a(0x24a)))throw new Error(_0x21564a(0x215)+_0x2ce8cf);const _0x4f2079=getStorageMode();let _0x51f747=null,_0x38c093=_0x21564a(0x200);if(_0x3b2cd1?.['isConnected'])_0x51f747=_0x3b2cd1,_0x38c093=_0x3b2cd1[_0x21564a(0x1c9)]?_0x21564a(0x233):_0x21564a(0x1ed),logger[_0x21564a(0x23a)]('['+_0x2ce8cf+_0x21564a(0x25f)+_0x38c093+'\x20storage\x20that\x20was\x20passed\x20in');else{if(!_0x3b2cd1&&!hasMongoDBUri())try{const {getSessionStorage:_0x26b6e7}=await import(_0x21564a(0x21d)),_0x14ab8e=_0x26b6e7();_0x14ab8e?.[_0x21564a(0x239)]?.[_0x21564a(0x203)]&&(_0x51f747=_0x14ab8e[_0x21564a(0x239)],_0x38c093='PostgreSQL',logger[_0x21564a(0x23a)]('['+_0x2ce8cf+_0x21564a(0x1c8)));}catch(_0x5092f7){logger[_0x21564a(0x23a)]('['+_0x2ce8cf+_0x21564a(0x1d4)+_0x5092f7['message']);}}logger['info']('['+_0x2ce8cf+_0x21564a(0x26f)+_0x4f2079[_0x21564a(0x259)]()+_0x21564a(0x1be)+_0x38c093+_0x21564a(0x210)+_0x1dc070+'\x20|\x20Pairing:\x20'+_0x2d9680);const _0xe3b032=new FileStorage(_0x2ce8cf);await _0xe3b032[_0x21564a(0x256)]();const _0x17bbb0=_0x51f747?new MongoBackgroundSync(_0x51f747,_0x2ce8cf,_0x4f2079):null;if(_0x17bbb0){globalCollectionRefs[_0x21564a(0x1ab)](_0x2ce8cf,_0x51f747);if(isMongoDBMode())logger['info']('['+_0x2ce8cf+']\x20ðŸ“¦\x20'+_0x38c093+_0x21564a(0x225));else isFileMode()&&logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+_0x21564a(0x254)+_0x38c093+_0x21564a(0x1e2));}else logger[_0x21564a(0x255)]('['+_0x2ce8cf+_0x21564a(0x1ef));if(_0x17bbb0&&isMongoDBMode()){logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+_0x21564a(0x1a9)+_0x38c093+'\x20auth\x20data\x20to\x20restore...');const _0x5313b4=await performInitialSync(_0xe3b032,_0x17bbb0,_0x2ce8cf);if(_0x5313b4[_0x21564a(0x1f5)]>0x0)logger['info']('['+_0x2ce8cf+_0x21564a(0x271)+_0x5313b4[_0x21564a(0x1f5)]+'/'+_0x5313b4['total']+'\x20files\x20from\x20'+_0x38c093);else{if(_0x5313b4[_0x21564a(0x24c)]>0x0&&_0x5313b4[_0x21564a(0x1ad)])logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+_0x21564a(0x248));else _0x5313b4['total']===0x0&&logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+']\x20No\x20'+_0x38c093+_0x21564a(0x1ee));}}else{if(_0x17bbb0&&isFileMode()){logger['info']('['+_0x2ce8cf+_0x21564a(0x1dd)+_0x38c093+_0x21564a(0x1a8));const _0x528482=await performInitialSync(_0xe3b032,_0x17bbb0,_0x2ce8cf);if(_0x528482[_0x21564a(0x1f5)]>0x0)logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+']\x20âœ…\x20Pulled\x20'+_0x528482[_0x21564a(0x1f5)]+'/'+_0x528482[_0x21564a(0x24c)]+_0x21564a(0x202)+_0x38c093+_0x21564a(0x246));else{if(_0x528482[_0x21564a(0x24c)]>0x0&&_0x528482[_0x21564a(0x1ad)])logger['info']('['+_0x2ce8cf+_0x21564a(0x26d));else{const _0x7cd626=await _0x17bbb0[_0x21564a(0x206)]();_0x7cd626[_0x21564a(0x1c2)]>0x0&&logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+_0x21564a(0x22b)+_0x38c093+'\x20has\x20'+_0x7cd626[_0x21564a(0x1c2)]+_0x21564a(0x237));}}logger['info']('['+_0x2ce8cf+_0x21564a(0x263)+_0x38c093+_0x21564a(0x20d));const _0x335b73=await _0xe3b032[_0x21564a(0x21f)]();if(_0x335b73[_0x21564a(0x1c2)]>0x0){let _0xf01d9c=0x0;for(const _0x37451c of _0x335b73){const _0x8fbb10=await _0xe3b032[_0x21564a(0x22d)](_0x37451c);_0x8fbb10&&(_0x17bbb0[_0x21564a(0x21c)](_0x37451c,_0x8fbb10),_0xf01d9c++);}_0xf01d9c>0x0&&logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+_0x21564a(0x25a)+_0xf01d9c+'/'+_0x335b73['length']+_0x21564a(0x25b)+_0x38c093+'\x20backup');}}}const _0x45a0a3=async _0x2270a4=>{const _0x1bfb28=_0x21564a;return await _0xe3b032[_0x1bfb28(0x22d)](_0x2270a4);},_0x42db14=async(_0x4edeb9,_0x5ab745)=>{const _0x558134=_0x21564a;await _0x23bb97[_0x558134(0x1e3)](_0xe3b032['dir'],{'recursive':!![]})['catch'](()=>{});if(_0x5ab745===_0x558134(0x247)){const _0x59f382=validateCredsForWrite(_0x4edeb9,_0x2ce8cf);if(!_0x59f382&&!_0x2d9680)return logger[_0x558134(0x251)]('['+_0x2ce8cf+_0x558134(0x214)),![];!_0x59f382&&_0x2d9680&&logger[_0x558134(0x255)]('['+_0x2ce8cf+']\x20âš ï¸\x20Writing\x20incomplete\x20creds.json\x20(pairing\x20in\x20progress)');const _0x48724f=await _0xe3b032['write'](_0x5ab745,_0x4edeb9);if(_0x17bbb0&&isMongoDBMode())_0x17bbb0['fireWrite'](_0x5ab745,_0x4edeb9),_0x48724f&&logger[_0x558134(0x1b4)]('['+_0x2ce8cf+_0x558134(0x1fa)+(_0x17bbb0[_0x558134(0x1c3)]?'\x20('+_0x38c093+_0x558134(0x207):'\x20('+_0x38c093+_0x558134(0x267)));else _0x48724f&&logger[_0x558134(0x1b4)]('['+_0x2ce8cf+']\x20âœ…\x20creds.json\x20written\x20to\x20file');return _0x48724f;}const _0x264e9f=isPreKeyFile(_0x5ab745);if(_0x264e9f)return debouncePreKeyWrite(_0x2ce8cf,_0x5ab745,async()=>{const _0x28e80b=_0x558134;await _0xe3b032['write'](_0x5ab745,_0x4edeb9),_0x17bbb0&&isMongoDBMode()&&_0x17bbb0[_0x28e80b(0x21c)](_0x5ab745,_0x4edeb9);}),!![];const _0x29d2f9=await _0xe3b032[_0x558134(0x1af)](_0x5ab745,_0x4edeb9);return _0x29d2f9&&_0x17bbb0&&isMongoDBMode()&&_0x17bbb0['fireWrite'](_0x5ab745,_0x4edeb9),_0x29d2f9;},_0x2b4072=async _0x152fc4=>{const _0x1e7045=_0x21564a;await _0xe3b032['delete'](_0x152fc4),_0x17bbb0&&_0x17bbb0[_0x1e7045(0x1f4)](_0x152fc4);},_0x44a210=await _0x45a0a3(_0x21564a(0x247)),_0x4b6405=hasBasicKeys(_0x44a210)?_0x44a210:initAuthCreds(),_0x3f7ef2=!_0x44a210;_0x3f7ef2?(logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+_0x21564a(0x1c6)),await _0x42db14(_0x4b6405,_0x21564a(0x247))):logger[_0x21564a(0x1b4)]('['+_0x2ce8cf+_0x21564a(0x270));let _0x3a4b84=null;if(isFileMode()&&_0x17bbb0){const _0x2c386f=async()=>{const _0x70c242=_0x21564a;try{const _0x5d99a4=await _0xe3b032['listFiles'](),_0x4ea5da=_0x17bbb0[_0x70c242(0x1d9)]();logger[_0x70c242(0x1b4)]('['+_0x2ce8cf+_0x70c242(0x218)+_0x5d99a4[_0x70c242(0x1c2)]+_0x70c242(0x20f)+_0x38c093+'\x20(health:\x20'+(_0x4ea5da[_0x70c242(0x1c3)]?_0x70c242(0x236):_0x70c242(0x1d2))+')');let _0x2d1295=0x0;for(const _0x35d6b5 of _0x5d99a4){if(!_0x17bbb0[_0x70c242(0x21b)](_0x35d6b5))continue;const _0x4fafbd=await _0xe3b032[_0x70c242(0x22d)](_0x35d6b5);_0x4fafbd&&(_0x17bbb0[_0x70c242(0x21c)](_0x35d6b5,_0x4fafbd),_0x2d1295++);}logger[_0x70c242(0x1b4)]('['+_0x2ce8cf+_0x70c242(0x252)+_0x2d1295+'/'+_0x5d99a4[_0x70c242(0x1c2)]+_0x70c242(0x20f)+_0x38c093);}catch(_0x5ef65a){logger[_0x70c242(0x251)]('['+_0x2ce8cf+_0x70c242(0x220)+_0x5ef65a[_0x70c242(0x1b3)]);}};logger['info']('['+_0x2ce8cf+_0x21564a(0x227)+_0x38c093+_0x21564a(0x1bc)+CONFIG[_0x21564a(0x250)]/0xea60+_0x21564a(0x1e9)),setTimeout(async()=>{const _0x382bc8=_0x21564a;logger[_0x382bc8(0x1b4)]('['+_0x2ce8cf+_0x382bc8(0x1ca)+_0x38c093+_0x382bc8(0x1eb)),await _0x2c386f(),_0x3a4b84=setInterval(_0x2c386f,CONFIG[_0x382bc8(0x250)]);},0x1388);}return{'state':{'creds':_0x4b6405,'keys':{'get':async(_0x116dd2,_0x2b9e56)=>{const _0xc70e08=_0x21564a,_0x2b8664={};for(const _0x4a0434 of _0x2b9e56){const _0x44d232=_0x116dd2+'-'+_0x4a0434+_0xc70e08(0x1cc);let _0x111e62=await _0x45a0a3(_0x44d232);_0x116dd2==='app-state-sync-key'&&_0x111e62&&(_0x111e62=_0x7df4d1[_0xc70e08(0x226)][_0xc70e08(0x1fb)]['fromObject'](_0x111e62));if(_0x111e62)_0x2b8664[_0x4a0434]=_0x111e62;}return _0x2b8664;},'set':async _0x46eb94=>{for(const _0x20a0e1 in _0x46eb94){for(const _0x5228f4 in _0x46eb94[_0x20a0e1]){const _0xfaa235=_0x46eb94[_0x20a0e1][_0x5228f4],_0x595219=_0x20a0e1+'-'+_0x5228f4+'.json';_0xfaa235?await _0x42db14(_0xfaa235,_0x595219):await _0x2b4072(_0x595219);}}}}},'saveCreds':()=>_0x42db14(_0x4b6405,'creds.json'),'cleanup':async()=>{const _0x14baca=_0x21564a;if(_0x3a4b84)clearInterval(_0x3a4b84);if(_0x17bbb0){const _0x2388a8=_0x17bbb0[_0x14baca(0x1d9)]();_0x2388a8[_0x14baca(0x201)]>0x0&&logger['info']('['+_0x2ce8cf+']\x20'+_0x38c093+'\x20sync\x20final:\x20'+_0x2388a8[_0x14baca(0x23f)]+'/'+_0x2388a8[_0x14baca(0x201)]+'\x20succeeded,\x20'+_0x2388a8[_0x14baca(0x211)]+_0x14baca(0x232)+(_0x2388a8['isHealthy']?_0x14baca(0x236):_0x14baca(0x1d2))+')'),_0x17bbb0[_0x14baca(0x25c)]();}await _0xe3b032[_0x14baca(0x25c)](),_0x17bbb0&&_0x17bbb0[_0x14baca(0x209)](),globalCollectionRefs[_0x14baca(0x234)](_0x2ce8cf),preKeyDebounceTimers[_0x14baca(0x234)](_0x2ce8cf),logger['info']('['+_0x2ce8cf+']\x20Cleanup\x20complete');}};};const debouncePreKeyWrite=(_0x1c8abe,_0xc766d6,_0xa687b7)=>{const _0x4acc55=_0xabe3a6;!preKeyDebounceTimers[_0x4acc55(0x217)](_0x1c8abe)&&preKeyDebounceTimers[_0x4acc55(0x1ab)](_0x1c8abe,new Map());const _0x4272a0=preKeyDebounceTimers[_0x4acc55(0x1db)](_0x1c8abe);_0x4272a0[_0x4acc55(0x217)](_0xc766d6)&&clearTimeout(_0x4272a0[_0x4acc55(0x1db)](_0xc766d6)),_0x4272a0[_0x4acc55(0x1ab)](_0xc766d6,setTimeout(async()=>{const _0x47bfb4=_0x4acc55;_0x4272a0[_0x47bfb4(0x234)](_0xc766d6);try{await _0xa687b7();}catch(_0x1b2f13){}},CONFIG[_0x4acc55(0x26e)]));};export const cleanupSessionAuthData=async(_0x40a1aa,_0x2bf4b2)=>{const _0x21c2ec=_0xabe3a6;try{const _0x1271b3=new FileStorage(_0x2bf4b2);await _0x1271b3['init'](),await _0x1271b3[_0x21c2ec(0x25c)]();if(hasMongoDBUri()&&_0x40a1aa?.['isConnected']){const _0x5c097c=new MongoBackgroundSync(_0x40a1aa,_0x2bf4b2,getStorageMode());_0x5c097c[_0x21c2ec(0x209)]();}return globalCollectionRefs['delete'](_0x2bf4b2),preKeyDebounceTimers['delete'](_0x2bf4b2),logger[_0x21c2ec(0x1b4)]('['+_0x2bf4b2+_0x21c2ec(0x265)),!![];}catch(_0xf2313c){return logger['error']('['+_0x2bf4b2+_0x21c2ec(0x1ea)+_0xf2313c['message']),![];}};export const hasValidAuthData=async(_0x25d2f0,_0x4191b1)=>{const _0x206c8a=_0xabe3a6;try{const _0x1e965d=new FileStorage(_0x4191b1);await _0x1e965d[_0x206c8a(0x256)]();const _0x5a64e7=await _0x1e965d[_0x206c8a(0x22d)]('creds.json');if(hasBasicKeys(_0x5a64e7))return!![];if(hasMongoDBUri()&&_0x25d2f0?.[_0x206c8a(0x203)])return await _0x25d2f0[_0x206c8a(0x1fd)](_0x4191b1);return![];}catch{return![];}};export const checkAuthAvailability=async(_0x51caf0,_0x2751c1)=>{const _0x738cbc=_0xabe3a6,_0x15f0fd=new FileStorage(_0x2751c1);await _0x15f0fd['init']();const _0x4b9c7a=await _0x15f0fd['exists']('creds.json');let _0x40a4cb=![];if(hasMongoDBUri()&&_0x51caf0?.[_0x738cbc(0x203)])try{_0x40a4cb=await _0x51caf0[_0x738cbc(0x1fd)](_0x2751c1);}catch{_0x40a4cb=![];}return{'hasFile':_0x4b9c7a,'hasMongo':_0x40a4cb,'hasAuth':_0x4b9c7a||_0x40a4cb,'preferred':_0x738cbc(0x243),'mode':'file-first-with-intelligent-backup','mongoAvailable':hasMongoDBUri()&&_0x51caf0?.[_0x738cbc(0x203)]};};export const getAuthStorageStats=()=>{const _0x57cf3e=_0xabe3a6,_0x57c518=getStorageMode(),_0x2035c3=hasMongoDBUri();let _0x41d353=_0x57cf3e(0x200);if(_0x2035c3){if(isMongoDBMode())_0x41d353=_0x57cf3e(0x1f6);else isFileMode()&&(_0x41d353=_0x57cf3e(0x1e6));}return{'storageMode':'FILE-FIRST','configuredMode':_0x57c518[_0x57cf3e(0x259)](),'mongodbAvailable':_0x2035c3,'backupStrategy':_0x41d353,'initialSyncDelay':CONFIG[_0x57cf3e(0x1f1)]/0x3e8+'s','backupInterval':CONFIG[_0x57cf3e(0x250)]/0xea60+_0x57cf3e(0x1b6),'syncBatchSize':CONFIG['SYNC_BATCH_SIZE'],'activeCollectionRefs':globalCollectionRefs[_0x57cf3e(0x1e4)],'description':_0x57cf3e(0x212)};};